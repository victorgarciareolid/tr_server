<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>Índex</title>

<!-- Socket.io -->
<script type="text/javascript" src="/socket.io/socket.io.js"></script>
<!-- JQuery -->
<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
<!-- AmCharts -->
	<script src="http://www.amcharts.com/lib/3/amcharts.js"></script>
	<script src="http://www.amcharts.com/lib/3/serial.js"></script>
<!-- Google Maps -->
	<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBknaxGs0YUizkvAUDk_cYaLO97SklnxcI"></script>

<style type="text/css">
	html, body{
	 height: 100%;
	 width: 100%;
	}
	#map{
		height: 460px;
	}
	.chart{
	 height: 460px;
	 width: 45%;
    }
     #charts, .charts{
        height: 460px;
		width: 100%;
        display: inline-flex;
    }
    .text{
        text-align: center;
        height: 460px;
        width: 45%;
        padding: 0;
        margin: 0;
    }
</style>

<script>
$(document).ready(function(){
    var live_charts = {}
    var socket = io.connect();
    var map_options = {
        center: { lat: 41.358889, lng: 2.099167},
	    zoom: 14
	};

    var live_charts_options = {
        "type":"serial",
        "categoryField": "date",
        "graphs" : [{"valueField": "concentration"}],
        "dataProvider" : []
    }

    var historical_charts_options = {
        "type": "serial",
        "categoryField": "date",
        "graphs": [{"valueField": "concentration"}],
        "dataProvider": []
    }

	var map = new google.maps.Map(document.getElementById("map"), map_options);

  socket.on("historical_data", function(response){
    boards = response.data;
    console.log(boards)
    for(board of boards){
        var name = board.name;
        var location = board.location;
        var options = historical_charts_options;
        addCircle(location, 1000, "#000000", map);
        
        $("#charts").append('<div id="' + name +'" class="charts"></div>');
        $("#" + name)
            .append('<div id="' + name + "historical" + '" class="chart"></div>')
            .append('<div id="' + name + "live" + '" class="text">Offline</div>');
        
            options.dataProvider = (board.measurements);
        createChart(name + "historical", options);
        
    }
  });
    
  socket.on("live_data", function(response){
    var board = response.data;
    
    var point = {
        "concentration": board.concentration,
        "date": ""
    }
    
    if(live_charts[board.name + "live"] === undefined){
        var options = live_charts_options;

        options.dataProvider.push(point)

        console.log(options)
        $("#" + board.name + "live")
            .text("")
            .removeClass("text")
            .addClass("chart");

            live_charts[board.name + "live"] = createChart(board.name + "live", options);
    }else{
        live_charts[board.name + "live"].dataProvider
            .push(point)
        live_charts[board.name + "live"].validateData();
    }

  });

});

var addCircle = function(center, radius, color, map){
	var circle = new google.maps.Circle({
		strokeWeight: 0,
		fillColor: color,
		fillOpacity: 0.35,
		map: map,
		center: center,
		radius: radius
	});
}

var createChart = function(name, options){
	var chart = AmCharts.makeChart(name, options);
	return chart;
}

</script>
</head>
<body>
    <head><h1>Título del projecto</h1></head>
	<div id="map"></div>
	<div id="charts"></div>
</body>
</html>
